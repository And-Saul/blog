{
  "hash": "91dd06690d0fcf20021cf7c472473224",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Canadian Births Time Series Analysis\"\nauthor: \"Andrew Saul\"\ndate: \"2025-01-16\"\ncategories: [Time-series, Modelling]\nimage: \"image.jpg\"\neditor: visual\nformat:\n  html:\n    code-fold: true\n    code-summary: \"Show the code\"\n    fig-numbering: true\n    tbl-cap-location: top\neditor_options: \n  chunk_output_type: console\n---\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nbirths_df <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/main/data/2024/2024-01-09/canada_births_1991_2022.csv')\n```\n:::\n\n\n\n## Introduction\n\nThis work was inspired from the Tidy Tuesday session titled [\"Canadian NHL Player Birth Dates\"](https://github.com/rfordatascience/tidytuesday/blob/main/data/2024/2024-01-09/readme.md). I utilised the R package [fpp3](https://otexts.com/fpp3/) to analyse the data.\n\n### Should births or birth rates be investigated?\n\nThe choice of variable is dependent upon the question being asked. A search using ChatGPT on this question revealed the following:\n\nLive births are the measure of absolute organic (excluding migration) growth per measurement period that contribute to the population size. This value is utilised for economic and resource planning, such as determining demand for resources like healthcare, education, housing, and social services.\n\nLive birth rate is the number of live births per 1,000 individuals in the population annually. It can be used for comparisons between countries or regions, regardless of population size. Birth rates are insightful for long-term analysis, especially in aging societies or declining populations\n\nFor the purposes of this blog I investigated births only\n\n### Goals of blog\n\nThe goals of this blog were two-fold. Primarily I was interested in developing code to reveal birth data insights. Secondly, I was interested in revealing components of the time series.\n\n## Birth data\n\nIn order to examine time-series data with the fpp3 package, the tibble data needs to be converted into a [**tsibble** object.](https://otexts.com/fpp3/tsibbles.html).\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# creation of tsibble object\nts_births <- \nbirths_df %>% \n  # create new column as year-month character - then convert it to a mth type using yearmonth function\n  mutate(ymdate = yearmonth(paste(year, month))) %>% \n  as_tsibble(index = ymdate)\n```\n:::\n\n\n\nA plot of the number of monthly births in Canada from January 1991 is displayed in @fig-fig1.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nts_births %>% \n  autoplot(births)+\n  labs(x = \"Year/Month\",\n       y = \"Births\",\n       title = \"Canadian Registered Births\")\n```\n\n::: {.cell-output-display}\n![Canadian births](index_files/figure-html/fig-fig1-1.png){#fig-fig1 width=672}\n:::\n:::\n\n\n\n### Seasonality\n\nWe can investigate the seasonality of the plot using the ggseason function\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nts_births %>% \n  gg_season(births, labels = \"both\")\n```\n\n::: {.cell-output-display}\n![Seasonality separated into years](index_files/figure-html/fig-fig2-1.png){#fig-fig2 width=672}\n:::\n:::\n\n\n\nIn @fig-fig2, each year is plotted separately. However, with over 30 lines this plot is difficult to interpret. Instead, seasonality can be plotted by facetting the ggplot into months.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nts_births %>% \n  gg_subseries(births, labels = \"both\")\n```\n\n::: {.cell-output-display}\n![Seasonality: trends observed for each month](index_files/figure-html/fig-fig3-1.png){#fig-fig3 width=672}\n:::\n:::\n\n\n\nIn @fig-fig3 it appears that most births occur in July (summer) and the fewest births occur in February (winter). One can also see from this plot that births peaked at the beginning of the time series and decreased to a minimum around 2001. From 2007 until 2021 the birth rate stabilised at a relatively high level, but fell once again for the final recorded year of 2022.\n\n## Correlations\n\nAn assumption of time series modelling is that the previous time point(s) influence the current time point.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nts_births %>% \n  gg_lag(births, lag = 1:12)+\n  labs(x = \"lag(birth, y_t)\", y = \"lag(birth, y_t-k\")\n```\n\n::: {.cell-output-display}\n![Lag in months](index_files/figure-html/fig-lag-1.png){#fig-lag width=672}\n:::\n:::\n\n\n\n@fig-lag represents the correlation between time points separated by months, depicted by the lag number. We can see that there is a strong, maximum correlation between time points separated by 12 months. This indicates yearly seasonal variation.\n\n### Autocorrelation Function (ACF)\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nts_births %>% \n  ACF(births) %>% \n  autoplot() +\n  labs(title = \"Canadian monthly birth data\")\n```\n\n::: {.cell-output-display}\n![Correlogram](index_files/figure-html/fig-acf-1.png){#fig-acf width=672}\n:::\n:::\n\n\n\nThe ACF depicts the relationships we see in the lag plots. A slow decline in ACF values vs lag number indicates that the value from the current time point is substantially influenced by values of time points both close and distant. A repeated pattern of increased ACF values indicate a seasonal component in the series. In  @fig-acf both trend and seasonality are present. The repeated pattern in the ACF indicates a large seasonal component. As this repeated pattern peaks at 12 and 24 months, the seasonal component is yearly. The gradual reduction in ACF value is due to the trend component.\n\n## Time Series Decompostion\n\n### Transformations\n\nWhen viewing @fig-fig1, the amount of variation should be consistant. For instance, the seasonal variation amplitude may increase by a constant factor over time. In order to maintain consistent variation, a transformation may be required.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlambda <- \n  ts_births %>% \n  features(births,features = \"guerrero\") %>% \n  pull(lambda_guerrero)\n\nts_births_bc <- \n  ts_births %>% \n  mutate(BC_births = box_cox(births, lambda))\n\nts_births_bc %>% \n  autoplot(BC_births)+\n    labs(y = \"\",\n       title = (paste0(\n         \"Transformed gas production with \\\\lambda = \",\n         round(lambda,2))))\n```\n\n::: {.cell-output-display}\n![Transformed Canadian birth time trend](index_files/figure-html/fig-transformation-1.png){#fig-transformation width=672}\n:::\n:::\n\n\n\nFor the population data, a box-cox transformation value was calculated to be 0.1273038. However, the variation seen in @fig-fig-transformation appeared similar to the non-transformed data in @fig-fig1, so therefore data transformation was not implemented for further analysis.\n\n### ARIMA\n\nARIMA models aim to describe the autocorrelations in the data\n\n#### Stage 1\n\nInvestigate the differencing between data points. The code below plots the difference between successive time points ie $y_t$ and $y_{t-1}$.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nts_births %>% \n  mutate(differencing = difference(births, lag=12)) %>% \n   autoplot(differencing) + labs(subtitle = \"Changes in monthly births\")\n```\n\n::: {.cell-output-display}\n![Differencing by one month](index_files/figure-html/fig-diff_births-1.png){#fig-diff_births width=672}\n:::\n:::\n\n\n\nIn figure @fig-diff_births the differencing by one month has not created a non-stationary plot.  However, when differencing by 12 months (@fig-12diff_births) less of the seasonality is present. \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nts_births %>% \n  mutate(differencing = difference(births, lag=12)) %>% \n   autoplot(differencing) + labs(subtitle = \"Changes in monthly births\")\n```\n\n::: {.cell-output-display}\n![Differencing by twelve months](index_files/figure-html/fig-12diff_births-1.png){#fig-12diff_births width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nts_births %>% \n  ACF(difference(births, lag=12)) %>% \n  autoplot() + labs(subtitle = \"Changes in monthly births\")\n```\n\n::: {.cell-output-display}\n![ACF plot of twelve month differencing](index_files/figure-html/fig-acfdiff-1.png){#fig-acfdiff width=672}\n:::\n:::\n\n\n\nFigure @fig-acfdiff demonstrates the non-stationary differencing effect in an ACF plot. Only lags around 12 were not greater than the significance levels (blue lines).  The slow decay of lagged values indicate that previous values heavily influence the current value.  Only those values around 12 months have little to no influence.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nts_births %>% \n  gg_tsdisplay(difference(births), plot_type='partial')\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-14-1.png){width=672}\n:::\n:::\n\n\n\n### STL decomposition (Seasonal and Trend decomposition using LOESS)\n\nSTL decomposition involves splitting up the data into trend/cyclical, seasonal and residual components. If it has been ascertained that the decomposition is multiplicative then components will need to be transformed. The Canadian population data appears additive and no transformation is deemed necessary.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n dcmp <- \n  ts_births_bc %>% \n  model(stl = STL(births))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ncomponents(dcmp) |>\n  as_tsibble() |>\n  autoplot(births, colour=\"gray\") +\n  geom_line(aes(y=trend), colour = \"#D55E00\") +\n  labs(\n    y = \"Births\",\n    title = \"Canadian Birth Data\"\n  )\n```\n\n::: {.cell-output-display}\n![Trend pattern overlaying the data](index_files/figure-html/fig-trendoverlay-1.png){#fig-trendoverlay width=672}\n:::\n:::\n\n\n\n@fig-trendoverlay demonstrates the trend component overlaying the complete plot.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n ts_births_bc %>% \n  model(stl = STL(births, robust = F)) %>% \n  components() %>% autoplot()\n```\n\n::: {.cell-output-display}\n![STL decomposition](index_files/figure-html/fig-stl-1.png){#fig-stl width=672}\n:::\n:::\n\n\n\n@fig-stl is a representation of the plot divided into the three STL components. The trend component is maximum at the beginning of the trace, then decreases to its minimum, finally regaining most of its gains with a period of stability before decreasing during the covid period. It is noteworthy that the seasonal component can change slowly over time. The bars on the side of each plots have the same length.\n\n## Forecasting\n\nBaseline (simple) forecasting methods include the mean, naive and seasonal naive methods. These methods often act as benchmarks to more complicated techniques\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# set training data before 2018\ntrain <- \n  ts_births %>% \n  filter(year <2018)\n\n#set period for forecast data\npred_pop <- \n  ts_births %>% \n  filter(year >=2018)\n\n#fit data\npop_fit <- \n  train %>% \n  model(\n    Mean = MEAN(births),\n    `Naïve` = NAIVE(births),\n    `Seasonal naïve` = SNAIVE(births),\n    Drift = NAIVE(births ~ drift())\n  )\n\n# produce forecasts for period 2019-2022\npop_2019_22 <- \n  pop_fit %>% \n  forecast(new_data = pred_pop)\n\n# plot data with forecasts\npop_2019_22 %>% \n  autoplot(ts_births %>% filter(year >=2014), level = NULL)+\n  autolayer(pred_pop, births, color = \"black\")\n```\n\n::: {.cell-output-display}\n![Benchmark forecast methods](index_files/figure-html/fig-benchmark-1.png){#fig-benchmark width=672}\n:::\n:::\n\n\n\n@fig-benchmark demonstrates four methods of benchmark forecasting. The mean method forecasts all future values as the average of all historical values. The Naive method forecasts all future values as the last observed value. The naive-seasonal method forecasts each new value to be equal to the last observed value from the same season. The drift method allows changes to increase or decrease in time, where the gradient is set as the average change seen in the historical data. In this figure the last four years were forecasted using the four methods.\n\n## Exponential Smoothing\n\nHistorically this technique has often been used for forecasting. Forecasts are produced by weighting past observations in an exponential manner. That is, the more recent the observation, the greater the weighting towards the forecast. A list of exponential smoothing factors are noted in chapter 8.4 of the fpp3 webbook.\n\n#### Holt-Winters method\n\nHolt-Winters method accounts not only for trend but also seasonality. The method comprises the forecasting equation, as well as three smoothing equations accounting for the level, trend and seasonality of the data.\n\nThe two variations of this method relate to the seasonal component. If the seasonal variations are constant though the series then the additive method is chosen. If however the variations are changing proportional to the level of the series then the multiplicative method is chosen.\n\nCode for the two seasonality models are shown below. A comparison of the fits for both models are compared.\n\n\n\n::: {#tbl-esacc .cell tbl-cap='Comparison of Additive and Multiplicative HW methods'}\n\n```{.r .cell-code}\nfit <- \n  ts_births %>% \n  model(\n    additive = ETS(births ~ error(\"A\") + trend(\"A\") + season(\"A\")),\n    multiplicative = ETS(births ~ error(\"M\") + trend(\"A\") + season(\"M\"))\n    )\n\nfc <- fit %>% forecast() \n```\n:::\n\n\n\n#### Fits of additive and multiplicative HW models\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\naugment(fit)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tsibble: 768 x 6 [1M]\n# Key:       .model [2]\n   .model     ymdate births .fitted  .resid  .innov\n   <chr>       <mth>  <dbl>   <dbl>   <dbl>   <dbl>\n 1 additive 1991 Jan  32213  33606. -1393.  -1393. \n 2 additive 1991 Feb  30345  30936.  -591.   -591. \n 3 additive 1991 Mar  34869  33865.  1004.   1004. \n 4 additive 1991 Apr  35398  34303.  1095.   1095. \n 5 additive 1991 May  36371  36493.  -122.   -122. \n 6 additive 1991 Jun  34378  35478. -1100.  -1100. \n 7 additive 1991 Jul  35436  35931.  -495.   -495. \n 8 additive 1991 Aug  34421  34932.  -511.   -511. \n 9 additive 1991 Sep  34410  34465.   -54.5   -54.5\n10 additive 1991 Oct  33092  33223.  -131.   -131. \n# ℹ 758 more rows\n```\n\n\n:::\n\n```{.r .cell-code}\ntidy(fit) %>% \n  spread(.model, estimate)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 17 × 3\n   term       additive multiplicative\n   <chr>         <dbl>          <dbl>\n 1 alpha      0.761           0.401  \n 2 b[0]     -26.3           -43.4    \n 3 beta       0.000112        0.00838\n 4 gamma      0.00241         0.360  \n 5 l[0]   34964.          35324.     \n 6 s[-1]  -1850.              0.911  \n 7 s[-10] -2915.              0.918  \n 8 s[-11] -1331.              0.953  \n 9 s[-2]    173.              0.975  \n10 s[-3]   1347.              1.02   \n11 s[-4]   1399.              1.01   \n12 s[-5]   1994.              1.06   \n13 s[-6]    678.              1.03   \n14 s[-7]   1573.              1.09   \n15 s[-8]    190.              1.05   \n16 s[-9]    490.              1.04   \n17 s[0]   -1748.              0.944  \n```\n\n\n:::\n:::\n\n\n\nNote that for the additive model, all the seasonal components add to 0. For the multiplicative model, all the seasonal components add to 1.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfc %>% \n  autoplot(filter(ts_births, ymdate >= yearmonth(\"2018 Jan\")), level = 95)\n```\n\n::: {.cell-output-display}\n![Comparison between the additive and multiplicative models](index_files/figure-html/fig-models-1.png){#fig-models width=672}\n:::\n:::\n\n\n\nIn @fig-models the difference between additive and multiplicative levels is small. However, the 95% prediction intervals are noticably greater for the additive model.\n\nWe can also investigate the effect of dampening on the additive (or multiplicative) model. This is a common method that performs extremely well. [See @11.40](https://otexts.com/fpp3/holt-winters.html) \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nts_births %>% \n  filter(year<2019) %>% \n  model(\n    hl = ETS(births ~ error(\"A\") + trend(\"Ad\") + season(\"A\"))\n  ) %>% \n  forecast(h = \"48 months\") %>% \nautoplot(ts_births |> filter(between (ymdate, yearmonth(\"2018 Jan\"), yearmonth(\"2022 Dec\"))))+\n  labs(title = str_wrap(\"80% & 95% prediction intervals for the dampend additive model on Canadian population for 2019-2022.\",80),\n       subtitle = c(\"The black line represents actual population values. The blue line represents the mean forecast.\"),\n       x = \"Date\")\n```\n\n::: {.cell-output-display}\n![Seasonal Additive Exponential Smoothing with Trend Dampening](index_files/figure-html/fig-expsmooth-1.png){#fig-expsmooth width=672}\n:::\n:::\n\n\n\nThe 80% and 95% confidence intervals calculated using the holt-linear method are displayed in @fig-expsmooth. The ETS function utilises state-space modelling to calculate the confidence intervals.\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}